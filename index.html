<!-- DEBUG: 2026-01-16 23:10 編集版 -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>MediaPipe → JSON → Unity</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico" />
  <link rel="stylesheet" href="TemplateData/style.css" />
  <style>
    body { font-family: sans-serif; margin: 16px; }
    #controls { margin-bottom: 12px; }
    canvas.mediapipe { border: 1px solid #ccc; max-width: 100%; }
  </style>
</head>

<body>
<h1>MediaPipe → JSON → Unity</h1>

<!-- ===== 操作UI ===== -->
<div id="controls">
  <input type="file" id="imageInput" accept="image/*" />
  <button id="detectBtn">検出</button>
  <button id="sendBtn" disabled>Unityへ送信</button>
</div>

<canvas id="mp-canvas" class="mediapipe"></canvas>
<hr />

<!-- ===== Unity 表示領域 ===== -->
<div id="unity-container" class="unity-desktop">
  <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
  <div id="unity-loading-bar">
    <div id="unity-logo"></div>
    <div id="unity-progress-bar-empty">
      <div id="unity-progress-bar-full"></div>
    </div>
  </div>
  <div id="unity-warning"></div>
  <div id="unity-footer">
    <div id="unity-logo-title-footer"></div>
    <div id="unity-fullscreen-button"></div>
    <div id="unity-build-title">MediaPipeStillImage2</div>
  </div>
</div>

<!-- ===== Unity ローダー ===== -->
<script>
const unityCanvas = document.querySelector("#unity-canvas");

function unityShowBanner(msg, type) {
  const warningBanner = document.querySelector("#unity-warning");
  const div = document.createElement("div");
  div.innerHTML = msg;
  warningBanner.appendChild(div);
  if (type === "error") div.style = "background:red;padding:10px;";
  if (type === "warning") div.style = "background:yellow;padding:10px;";
}

const buildUrl = "Build";
const loaderUrl = buildUrl + "/pose-viewer.loader.js";
const config = {
  dataUrl: buildUrl + "/pose-viewer.data.unityweb",
  frameworkUrl: buildUrl + "/pose-viewer.framework.js.unityweb",
  codeUrl: buildUrl + "/pose-viewer.wasm.unityweb",
  streamingAssetsUrl: "StreamingAssets",
  companyName: "DefaultCompany",
  productName: "MediaPipeStillImage2",
  productVersion: "0.1.0",
  showBanner: unityShowBanner,
};

document.querySelector("#unity-loading-bar").style.display = "block";

const script = document.createElement("script");
script.src = loaderUrl;
script.onload = () => {
  createUnityInstance(unityCanvas, config, (progress) => {
    document.querySelector("#unity-progress-bar-full").style.width = (100 * progress) + "%";
  }).then((unityInstance) => {
    window.unityInstance = unityInstance;
    document.querySelector("#unity-loading-bar").style.display = "none";
    document.querySelector("#unity-fullscreen-button").onclick = () => {
      unityInstance.SetFullscreen(1);
    };
    console.log("Unity 起動完了");
  }).catch(alert);
};
document.body.appendChild(script);
</script>

<!-- ===== MediaPipe 部分 ===== -->
<script type="module">
import { PoseLandmarker, FilesetResolver, DrawingUtils }
  from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

const canvas = document.getElementById("mp-canvas");
const ctx = canvas.getContext("2d");
const imageInput = document.getElementById("imageInput");
const detectBtn = document.getElementById("detectBtn");
const sendBtn = document.getElementById("sendBtn");

let poseLandmarker;
let lastResult = null;
let loadedImage = null;

/* 初期化 */
const vision = await FilesetResolver.forVisionTasks(
  "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
);

poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
  baseOptions: {
    modelAssetPath:
      "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",
    delegate: "GPU"
  },
  runningMode: "IMAGE",
  numPoses: 1
});

/* 画像読み込み */
imageInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const img = new Image();
  img.onload = () => {
    loadedImage = img;
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;
    ctx.drawImage(img, 0, 0);
  };
  img.src = URL.createObjectURL(file);
});

/* 検出 */
detectBtn.addEventListener("click", async () => {
  if (!loadedImage) {
    alert("画像を選択してください");
    return;
  }
  const result = await poseLandmarker.detect(loadedImage);
  lastResult = result;

  ctx.drawImage(loadedImage, 0, 0, canvas.width, canvas.height);
  const draw = new DrawingUtils(ctx);
  for (const lm of result.landmarks) {
    draw.drawLandmarks(lm);
    draw.drawConnectors(lm, PoseLandmarker.POSE_CONNECTIONS);
  }
  sendBtn.disabled = false;
});

/* Unity送信 + JSON保存 */
sendBtn.addEventListener("click", () => {
  console.log("send button clicked");
  if (!lastResult) return;

  const json = JSON.stringify(lastResult, null, 2);
  downloadJson(json);

  if (!window.unityInstance) {
    alert("Unityがまだ起動していません");
    return;
  }

  window.unityInstance.SendMessage(
    "PoseBootstrap",
    "LoadPoseFromJson",
    json
  );
});

/* JSONダウンロード */
function downloadJson(text) {
  const blob = new Blob([text], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const now = new Date();
  a.download =
    "pose_" +
    now.getFullYear() +
    ("0" + (now.getMonth()+1)).slice(-2) +
    ("0" + now.getDate()).slice(-2) + "_" +
    ("0" + now.getHours()).slice(-2) +
    ("0" + now.getMinutes()).slice(-2) +
    ("0" + now.getSeconds()).slice(-2) +
    ".json";
  a.href = url;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
