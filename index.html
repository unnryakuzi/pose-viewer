<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>MediaPipe & Pose Loader</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico" />
  <link rel="stylesheet" href="TemplateData/style.css" />
  <style>
    body { font-family: sans-serif; margin: 16px; }
    #controls { margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd; }
    .control-group { margin: 10px 0; padding: 5px; }
    .section-title { font-weight: bold; display: block; border-bottom: 1px solid #ccc; margin-bottom: 8px; color: #333; }
    canvas.mediapipe { border: 1px solid #ccc; max-width: 100%; display: block; margin-bottom: 16px; }
    #unity-container { position: relative !important; margin-top: 16px; }
    #unity-canvas { display: block; margin: 0 auto; width: 960px; height: 600px; }
  </style>
</head>

<body>
<h1>MediaPipe & Pose Loader</h1>

<div id="controls">
  <div class="control-group">
    <span class="section-title">1. 画像からポーズ検出 (MediaPipe)</span>
    <input type="file" id="imageInput" accept="image/*" />
    <button id="detectBtn">検出</button>
    <button id="sendBtn" disabled>Unityへ送信</button>
  </div>

  <div class="control-group" style="margin-top: 15px; background: #fff; border: 1px dashed #aaa; padding: 10px;">
    <span class="section-title">2. 保存済みポーズ(JSON)の反映</span>
    <input type="file" id="jsonLoadInput" accept=".json" />
    <button id="manualLoadBtn">JSONを反映</button>
  </div>

  <div class="control-group" style="margin-top: 15px; background: #eef9ff; border: 1px solid #b2d7ff; padding: 10px;">
    <span class="section-title">3. Unity上のポーズを保存</span>
    <button id="savePoseBtn">現在のポーズをJSONでダウンロード</button>
  </div>
</div>

<canvas id="mp-canvas" class="mediapipe"></canvas>
<hr />

<div id="unity-container" class="unity-desktop">
  <canvas id="unity-canvas" tabindex="-1"></canvas>
  <div id="unity-loading-bar">
    <div id="unity-logo"></div>
    <div id="unity-progress-bar-empty">
      <div id="unity-progress-bar-full"></div>
    </div>
  </div>
  <div id="unity-warning"></div>
</div>

<script src="Build/pose-viewer.loader.js"></script>

<script>
  // Unityの設定
  const unityCanvas = document.querySelector("#unity-canvas");
  const buildUrl = "Build";
  const config = {
    dataUrl: "Build/pose-viewer.data",
    frameworkUrl: "Build/pose-viewer.framework.js",
    codeUrl: "Build/pose-viewer.wasm",
    streamingAssetsUrl: "StreamingAssets",
    companyName: "DefaultCompany",
    productName: "pose-viewer",
    productVersion: "0.1",
  };

  let unityInstance = null;

  // ページロード完了後にUnityを起動
  window.onload = () => {
    document.querySelector("#unity-loading-bar").style.display = "block";
    
    // pose-viewer.loader.jsが読み込まれていれば、ここでcreateUnityInstanceが使える
    createUnityInstance(unityCanvas, config, (progress) => {
      document.querySelector("#unity-progress-bar-full").style.width = (100 * progress) + "%";
    }).then((instance) => {
      unityInstance = instance;
      window.unityInstance = instance;
      document.querySelector("#unity-loading-bar").style.display = "none";
      console.log("Unity 起動完了");
    }).catch(alert);
  };

  // JSON反映ボタンのロジック
  document.getElementById("manualLoadBtn").addEventListener("click", () => {
    const file = document.getElementById("jsonLoadInput").files[0];
    if (!file) return alert("JSONファイルを選択してください");
    const reader = new FileReader();
    reader.onload = (e) => {
      if (window.unityInstance) {
        window.unityInstance.SendMessage("PoseBootstrap", "LoadPoseFromJson", e.target.result);
      }
    };
    reader.readAsText(file);
  });

  // index.html の script タグ内に追加
  document.getElementById("savePoseBtn").addEventListener("click", () => {
    if (window.unityInstance) {
      // PoseBootstrap オブジェクトの RequestSavePose 関数を呼び出す
      window.unityInstance.SendMessage("PoseBootstrap", "RequestSavePose");
    } else {
      alert("Unityがまだ起動していないか、インスタンスが見つかりません。");
    }
  });
</script>

<script type="module">
  // ESM形式でインポート
  import { PoseLandmarker, FilesetResolver, DrawingUtils } 
    from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

  const canvas = document.getElementById("mp-canvas");
  const ctx = canvas.getContext("2d");
  const imageInput = document.getElementById("imageInput");
  const detectBtn = document.getElementById("detectBtn");
  const sendBtn = document.getElementById("sendBtn");

  let poseLandmarker;
  let lastResult = null;
  let loadedImage = null;

  // 初期化
  async function initMediaPipe() {
    const vision = await FilesetResolver.forVisionTasks(
      "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
    );
    poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
      baseOptions: {
        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",
        delegate: "GPU"
      },
      runningMode: "IMAGE"
    });
  }
  initMediaPipe();

  imageInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const img = new Image();
    img.onload = () => {
      loadedImage = img;
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      ctx.drawImage(img, 0, 0);
    };
    img.src = URL.createObjectURL(file);
  });

  detectBtn.addEventListener("click", async () => {
    if (!poseLandmarker || !loadedImage) return;
    const result = await poseLandmarker.detect(loadedImage);
    const poseFrame = { landmarks: [] };
    if (result.landmarks && result.landmarks[0]) {
      result.landmarks[0].forEach(lm => {
        poseFrame.landmarks.push({ x: lm.x, y: lm.y, z: lm.z, visibility: lm.visibility ?? 1.0 });
      });
    }
    lastResult = poseFrame;
    ctx.drawImage(loadedImage, 0, 0);
    const draw = new DrawingUtils(ctx);
    result.landmarks?.forEach(lm => {
      draw.drawLandmarks(lm);
      draw.drawConnectors(lm, PoseLandmarker.POSE_CONNECTIONS);
    });
    sendBtn.disabled = false;
  });

  sendBtn.addEventListener("click", () => {
    if (lastResult && window.unityInstance) {
      window.unityInstance.SendMessage("PoseBootstrap", "LoadPoseFromJson", JSON.stringify(lastResult));
    }
  });
</script>
</body>
</html>